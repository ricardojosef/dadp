<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PCP - F√°brica dos Parafusos</title>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Sora', sans-serif;
      background: #f5f6fa;
      color: #333;
      margin: 0;
      padding: 0;
    }

    nav {
      background-color: #007bff;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 40px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    nav h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    nav .links {
      display: flex;
      gap: 15px;
    }

    nav a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    nav a:hover {
      opacity: 0.8;
    }

    main {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 40px;
      gap: 40px;
    }

    .col-esquerda { flex: 2; }
    .col-direita {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      height: fit-content;
    }

    .contador {
      background: #f5f6fa;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      font-size: 22px;
      font-weight: bold;
      color: #007bff;
    }

    select, input, button {
      margin: 5px;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      transition: background 0.3s;
    }

    button:hover { background-color: #0056b3; }
    #reset { background-color: #e74c3c; }
    #reset:hover { background-color: #c0392b; }
    #limparAndon { background-color: #f39c12; }
    #limparAndon:hover { background-color: #d68910; }

    #fila, #postos {
      margin: 25px auto;
      width: 100%;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
    }

    h2 { color: #007bff; }
    .pedido {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 8px 10px;
      margin: 5px 0;
      border-left: 4px solid #007bff;
    }

    .tempo { font-size: 14px; color: gray; }
  </style>
</head>
<body>

  <nav>
    <h1>üè≠ PCP - F√°brica dos Parafusos</h1>
    <div class="links">
      <a href="https://ricardojosef.github.io/dadp/pcp">PCP</a>
      <a href="https://ricardojosef.github.io/dadp/posto1">Posto 1</a>
      <a href="https://ricardojosef.github.io/dadp/posto2">Posto 2</a>
      <a href="https://ricardojosef.github.io/dadp/posto3">Posto 3</a>
      <a href="https://ricardojosef.github.io/dadp/posto4">Posto 4</a>
    </div>
  </nav>

  <main>
    <div class="col-esquerda">
      <div>
        <label>Tipo:</label>
        <select id="tipo">
          <option value="pequeno">Parafuso pequeno</option>
          <option value="grande">Parafuso grande</option>
        </select>

        <label>Quantidade:</label>
        <input type="number" id="qtd" placeholder="Qtd" min="1"/>

        <button id="add">Adicionar Ordem</button>
        <button id="reset">Reiniciar Dia</button>
        <button id="limparAndon">Limpar ANDON</button>
      </div>

      <h2>üì¶ Fila de Ordens</h2>
      <div id="fila"></div>

      <h2>üß∞ Status dos Postos</h2>
      <div id="postos"></div>
    </div>

    <div class="col-direita">
      <h2>üìä Produ√ß√£o</h2>
      <div class="contador" id="ppCount">Parafusos Pequenos: 0</div>
      <div class="contador" id="pgCount">Parafusos Grandes: 0</div>
    </div>
  </main>

  <script type="module">
    import { db, ref, push, set, onValue, update, remove, get } from "./firebase.js";

async function gerarNumeroPedido() {
  const snapshot = await get(ref(db, "orders"));
  const data = snapshot.val() || {};
  const total = Object.keys(data).length;
  const numero = (total + 1).toString().padStart(3, "0");
  return "PED-" + numero;
}

document.getElementById("add").onclick = async () => {
  const tipo = document.getElementById("tipo").value;
  const qtd = Number(document.getElementById("qtd").value);
  if (!qtd || qtd <= 0) {
    alert("Informe uma quantidade v√°lida!");
    return;
  }

  const numeroBase = await gerarNumeroPedido();
  const timestampInicio = new Date().toISOString();

  // üîπ Gera pedidos individuais (um por pe√ßa)
  for (let i = 1; i <= qtd; i++) {
    const novaOrdem = {
      numero: `${numeroBase}-${i}`,
      tipo,
      qtd: 1,
      etapa: 0,
      status: "pendente",
      timestampInicio
    };
    await push(ref(db, "orders"), novaOrdem);
  }

  document.getElementById("qtd").value = "";
};

// üîπ Reiniciar dia
document.getElementById("reset").onclick = async () => {
  if (confirm("Tem certeza que deseja reiniciar o dia? Isso apagar√° todas as ordens.")) {
    await remove(ref(db, "orders"));
    alert("‚úÖ Todos os pedidos foram apagados!");
  }
};

// üîπ Limpar ANDON
document.getElementById("limparAndon").onclick = async () => {
  if (confirm("Deseja limpar todos os alertas de ANDON?")) {
    const snapshot = await get(ref(db, "posts"));
    const posts = snapshot.val() || {};
    for (const id in posts) {
      await update(ref(db, "posts/" + id), { andon: "ok" });
    }
    alert("‚úÖ Todos os alertas de ANDON foram limpos!");
  }
};

// üîπ Atualiza lista e contadores
onValue(ref(db, "orders"), (snap) => {
  const div = document.getElementById("fila");
  div.innerHTML = "";
  const orders = snap.val();
  if (!orders) {
    div.innerHTML = "<i>Sem pedidos no momento</i>";
    return;
  }

  let countPP = 0, countPG = 0;

  const lista = Object.entries(orders).reverse();
  lista.forEach(([id, o]) => {
    let tempoTxt = "";

    if (o.timestampInicio) {
      const inicio = new Date(o.timestampInicio);
      const horaInicio = inicio.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });

      if (o.status === "finalizado" && o.timestampFim) {
        const fim = new Date(o.timestampFim);
        const horaFim = fim.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        const duracaoSeg = Math.round((fim - inicio) / 1000);
        const min = Math.floor(duracaoSeg / 60);
        const seg = duracaoSeg % 60;
        tempoTxt = `<div class="tempo">üïí In√≠cio: ${horaInicio} | ‚úÖ Fim: ${horaFim} | ‚è±Ô∏è ${min}min ${seg}s</div>`;
      } else {
        tempoTxt = `<div class="tempo">üïí Iniciado √†s ${horaInicio}</div>`;
      }
    }

    // üîπ Corrige contagem total de parafusos produzidos
    if (o.status === "finalizado") {
      if (o.tipo === "pequeno") countPP += o.qtd || 1;
      if (o.tipo === "grande") countPG += o.qtd || 1;
    }

    div.innerHTML += `
      <div class="pedido">
        <b>${o.numero}</b> ‚Äî ${o.tipo} ‚Äî qtd: ${o.qtd} ‚Äî etapa: ${o.etapa} ‚Äî status: ${o.status}
        ${tempoTxt}
      </div>
    `;
  });

  document.getElementById("ppCount").innerText = `Parafusos Pequenos: ${countPP}`;
  document.getElementById("pgCount").innerText = `Parafusos Grandes: ${countPG}`;
});

// üîπ Atualiza status dos postos
onValue(ref(db, "posts"), (snap) => {
  const div = document.getElementById("postos");
  const p = snap.val() || {};
  div.innerHTML = "";
  Object.entries(p).forEach(([id, post]) => {
    div.innerHTML += `<div>Posto ${id} ‚Äî atual: ${post.currentOrder || "-"} ‚Äî ANDON: ${post.andon || "ok"}</div>`;
  });
});

  </script>

</body>
</html>
