<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Posto 1</title>
  <style>
    button#feito {
      height: 500px;
      width: 500px;
      background-color: rgb(69, 204, 69);
      font-size: 40px;
      font-weight: bold;
    }
    button#andon {
      height: 500px;
      width: 500px;
      background-color: rgb(204, 69, 69);
      font-size: 40px;
      font-weight: bold;
    }
    div#ordem {
      font-size: 150px;
    }
  </style>
</head>
<body>
  <h1>Posto 1</h1>

  <div id="ordem">Carregando...</div>

  <button id="feito">Tarefa concluída</button>
  <button id="andon">ACIONAR ANDON</button>

  <script type="module">
    import { db, ref, onValue, update } from "./firebase.js";

    const posto = 1;

    // Escuta as ordens cujo campo etapa == 0 (posto1)
    onValue(ref(db, "orders"), snap => {
      const orders = snap.val() || {};
      let found = null;
      for (const [id, o] of Object.entries(orders)) {
        if (Number(o.etapa) === 0 && o.status !== "finalizado") {
          found = { id, o };
          break;
        }
      }

      const div = document.getElementById("ordem");
      if (found) {
        div.innerText = `Ordem atual: #${found.id} — ${found.o.tipo}`;
      } else {
        div.innerText = "Sem ordem";
      }
      window.currentOrder = found;
    });

    // Concluir tarefa deste posto
    document.getElementById("feito").onclick = () => {
      if (!window.currentOrder) return;
      update(ref(db, "orders/" + window.currentOrder.id), {
        etapa: 1, // vai pro posto2
        status: "em progresso"
      });
    };

    // Acionar ANDON
    document.getElementById("andon").onclick = () => {
      const postRef = ref(db, "posts/" + posto);
      update(postRef, { andon: "ALERTA" });
      setTimeout(() => update(postRef, { andon: "ok" }), 5000);
    };
  </script>
</body>
</html>
