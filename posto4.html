<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Posto 4</title></head>
<body>
<h1>Posto 4</h1>

<div id="ordem"></div>

<button id="feito">Tarefa concluída</button>
<button id="andon">ACIONAR ANDON</button>

<script type="module">
import {db, ref, onValue, update, increment} from "./firebase.js";

const posto = 4

// escuta ordens cujo campo etapa == 3  (posto4)
onValue(ref(db,"orders"), snap=>{
  const orders = snap.val()||{}
  let found = false
  for(const [id,o] of Object.entries(orders)){
    if(o.etapa === 3 && o.status!="finalizado"){
      found = {id,o}
      break
    }
  }
  document.getElementById("ordem").innerText = found ? 
    `Ordem atual: #${found.id} — ${found.o.tipo}` :
    "Sem ordem"
  window.currentOrder = found
})

// concluir tarefa deste posto (FINALIZA)
document.getElementById("feito").onclick = ()=>{
  if(!window.currentOrder) return
  
  const orderId = window.currentOrder.id
  const tipo = window.currentOrder.o.tipo  // pequeno ou grande

  // marca ordem como finalizada
  update(ref(db,"orders/"+orderId),{
    etapa: 999,
    status: "finalizado"
  })

  // incrementa contador de produção
  update(ref(db,"prodCount"),{
    [tipo]: increment(1)
  })
}

// andon
document.getElementById("andon").onclick = ()=>{
  update(ref(db,"posts/"+posto), {andon:"ALERTA"})
}
</script>
</body>
</html>
